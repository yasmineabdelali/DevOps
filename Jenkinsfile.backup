pipeline {
    agent any
    
    environment {
        DOCKERHUB_CREDENTIALS = credentials('dockerhub-credentials')
        IMAGE_NAME = "yasmineabdelali/student-management"
    }
    
    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }
        
        stage('CrÃ©ation Image Docker') {
            steps {
                script {
                    echo "ðŸš€ Construction de l'image Docker..."
                    sh """
                    docker build -t ${IMAGE_NAME}:latest .
                    docker tag ${IMAGE_NAME}:latest ${IMAGE_NAME}:\${BUILD_NUMBER}
                    """
                }
            }
        }
        
        stage('Push Image DockerHub') {
            steps {
                script {
                    echo "ðŸš€ Push vers DockerHub..."
                    withCredentials([usernamePassword(
                        credentialsId: 'dockerhub-credentials',
                        usernameVariable: 'DOCKER_USER',
                        passwordVariable: 'DOCKER_PASS'
                    )]) {
                        sh """
                        echo \$DOCKER_PASS | docker login -u \$DOCKER_USER --password-stdin
                        docker push ${IMAGE_NAME}:latest
                        docker push ${IMAGE_NAME}:\${BUILD_NUMBER}
                        """
                    }
                }
            }
        }
    }
    
    post {
        always {
            sh 'docker logout'
        }
        success {
            echo 'ðŸŽ‰ PIPELINE RÃ‰USSI! Deux stages exÃ©cutÃ©s:'
            echo 'âœ… 1. CrÃ©ation Image Docker'
            echo 'âœ… 2. Push Image DockerHub'
        }
    }
}